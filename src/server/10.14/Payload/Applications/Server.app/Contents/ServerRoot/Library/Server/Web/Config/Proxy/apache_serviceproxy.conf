DocumentRoot /Library/Server/Web/Data/Sites/Default
ServerRoot /usr
DirectoryIndex index.html index.php default.html
ErrorLog "/private/var/log/apache2/service_proxy_error.log"
CustomLog "/private/var/log/apache2/service_proxy_access.log" combinedvhost
LogLevel info ssl:info
PidFile /var/run/service_proxy.pid
User _www
Group _www

Listen 80
Listen 443

LoadModule dir_module libexec/apache2/mod_dir.so
LoadModule authz_core_module libexec/apache2/mod_authz_core.so
LoadModule unixd_module libexec/apache2/mod_unixd.so
LoadModule ssl_module libexec/apache2/mod_ssl.so
LoadModule rewrite_module libexec/apache2/mod_rewrite.so
LoadModule setenvif_module libexec/apache2/mod_setenvif.so
LoadModule env_module libexec/apache2/mod_env.so
LoadModule socache_shmcb_module libexec/apache2/mod_socache_shmcb.so
LoadModule mime_module libexec/apache2/mod_mime.so
LoadModule proxy_module libexec/apache2/mod_proxy.so
LoadModule proxy_http_module libexec/apache2/mod_proxy_http.so
LoadModule macro_module libexec/apache2/mod_macro.so
LoadModule proxy_connect_module libexec/apache2/mod_proxy_connect.so
LoadModule proxy_fcgi_module libexec/apache2/mod_proxy_fcgi.so
LoadModule proxy_scgi_module libexec/apache2/mod_proxy_scgi.so
LoadModule proxy_wstunnel_module libexec/apache2/mod_proxy_wstunnel.so
LoadModule proxy_ajp_module libexec/apache2/mod_proxy_ajp.so
LoadModule proxy_balancer_module libexec/apache2/mod_proxy_balancer.so
LoadModule proxy_express_module libexec/apache2/mod_proxy_express.so
LoadModule slotmem_shm_module libexec/apache2/mod_slotmem_shm.so
LoadModule lbmethod_byrequests_module libexec/apache2/mod_lbmethod_byrequests.so
LoadModule headers_module libexec/apache2/mod_headers.so
LoadModule alias_module libexec/apache2/mod_alias.so
LoadModule authn_file_module libexec/apache2/mod_authn_file.so
LoadModule authn_core_module libexec/apache2/mod_authn_core.so
LoadModule authz_host_module libexec/apache2/mod_authz_host.so
LoadModule authz_groupfile_module libexec/apache2/mod_authz_groupfile.so
LoadModule authz_user_module libexec/apache2/mod_authz_user.so
LoadModule access_compat_module libexec/apache2/mod_access_compat.so
LoadModule log_config_module libexec/apache2/mod_log_config.so
LoadModule hfs_apple_module libexec/apache2/mod_hfs_apple.so
LoadModule negotiation_module libexec/apache2/mod_negotiation.so
LoadModule reqtimeout_module libexec/apache2/mod_reqtimeout.so
LoadModule status_module libexec/apache2/mod_status.so

# Language settings
Include /private/etc/apache2/extra/httpd-languages.conf

# prevent .htaccess and .htpasswd and .DS_Store files from being viewed by Web clients.
<FilesMatch "^\.([Hh][Tt]|[Dd][Ss]_[Ss])">
    Require all denied
</FilesMatch>

# Apple specific filesystem protection.
<Files "rsrc">
    Require all denied
</Files>
<DirectoryMatch ".*\.\.namedfork">
    Require all denied
</DirectoryMatch>

LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
LogFormat "%v \"%{HOST}i\" %h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combinedvhost
LogFormat "%h %l %u %t \"%r\" %>s %b" common
LogFormat "%v %h %l %u %t \"%r\" %>s %b" commonvhost

<IfModule mod_ssl.c>
    SSLProtocol -all +TLSv1.2
    SetEnvIf User-Agent ".*MSIE.*" nokeepalive ssl-unclean-shutdown
    SSLPassPhraseDialog exec:/Library/Server/Web/Config/apache2/getsslpassphrase
    SSLSessionCache shmcb:/var/run/ssl_scache(512000)
    SSLSessionCacheTimeout 300
    SSLRandomSeed startup builtin
    SSLRandomSeed connect builtin
    AddType application/x-x509-ca-cert crt
    AddType application/x-pkcs7-crl crl
</IfModule>

<Directory /Library/Server/Web/Data/Sites/Default>
    AllowOverride None
    Options MultiViews FollowSymlinks
    Require all granted
    Header Set Cache-Control no-cache
</Directory>
Alias /sitedefault /Library/Server/Web/Data/Sites/Default/default.html

<Location />
	ErrorDocument 503 /sitedefault
</Location>

ProxyPass /sitedefault !

<Directory ${SERVER_INSTALL_PATH_PREFIX}/usr/share/web/customerror>
    AllowOverride None
    Options MultiViews FollowSymlinks
	Require all granted
	Header Set Cache-Control no-cache
</Directory>
Alias /customerror ${SERVER_INSTALL_PATH_PREFIX}/usr/share/web/customerror

<Location /profilemanager>
	ErrorDocument 503 /customerror/profilemanager.html
</Location>
<Location /mydevices>
    ErrorDocument 503 /customerror/profilemanager.html
</Location>

ProxyPass /customerror !

<VirtualHost *:80>
    ProxyPreserveHost On
    SetEnv proxy-chain-auth on
    RequestHeader set X-Forwarded-Proto "http"
    RequestHeader set X-Forwarded-Port "80"
    RequestHeader unset Proxy early
    Include /Library/Server/Web/Config/apache2/httpd_devicemanagement.conf
</VirtualHost>

<VirtualHost *:443>
    ProxyPreserveHost On
    SetEnv proxy-chain-auth on
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"
    RequestHeader unset Proxy early

<IfModule mod_ssl.c>
    SSLEngine On
    SSLCertificateFile "/etc/certificates/${CERT_ID}.cert.pem"
    SSLCertificateKeyFile "/etc/certificates/${CERT_ID}.key.pem"
    SSLCertificateChainFile "/etc/certificates/${CERT_ID}.chain.pem"
    SSLHonorCipherOrder On
    SSLCipherSuite "HIGH:MEDIUM:!MD5:!RC4:!3DES"
    SSLProtocol -all +TLSv1.2
    SSLProxyEngine On
    SSLProxyProtocol -all +TLSv1.2
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
</IfModule>

Include /Library/Server/Web/Config/apache2/httpd_devicemanagement_ssl.conf
Include /Library/Server/Web/Config/apache2/httpd_devicemanagement.conf
IncludeOptional /etc/wfs/httpd_webdavsharing_proxy.conf

</VirtualHost>
