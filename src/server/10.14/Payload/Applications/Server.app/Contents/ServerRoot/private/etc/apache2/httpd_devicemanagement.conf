# Profile Manager has three main services, each on different URIs
#
# 1) The web admin, at /profilemanager and /devicemanagement/console (static files)
#    and /devicemanagement/webapi for AJAX requests to the backend Rails code.
# 2) The user portal, at /mydevices and /devicemanagement/webapi/device/start_ota (static files)
#    and /devicemanagement/webapi for AJAX requests to the backend Rails code.
# 3) The device server, at /devicemanagement/mdm/device and/or /devicemanagement/api/device
#
# There are some other URIs which simply serve miscellaneous content directly from files in the file system.
# These are always proxied to Profile Manager's backend apache instance, with the URI rewritten as noted
#
# /MDMServiceConfig                         --> /config/MDMServiceConfig
# /devicemanagement/DEPAnchorCerts.json     --> /config/DEPAnchorCerts.json
# /devicemanagement/*.mobileconfig          --> /config/*.mobileconfig
# /devicemanagement/book/*                  --> /book/*
# /devicemanagement/ipa/*                   --> /app/*
#
# This file is used to configure the reverse proxy which listens on both ports 80 & 443.
# Connections to the Rails backend  are proxied from here directly to the "thin" instances running the Rails code.
# The DeviceService code *only* applies to SSL connections, so that is configured in httpd_devicemanagement_ssl.conf.
# All request for files used by Profile Manager are proxied to a backend web server running only for Profile Manager,
# which is configured in services/httpd_devicemanagement.conf.

# LogLevel info rewrite:trace5 alias:trace5

# Language settings
Include "/Applications/Server.app/Contents/ServerRoot/etc/apache2/services/extra/httpd-languages.conf"

TypesConfig "/Applications/Server.app/Contents/ServerRoot/etc/apache2/services/extra/mime.types"
AddType application/x-compress .Z
AddType application/x-gzip .gz .tgz
AddType application/x-apple-aspen-config .mobileconfig
AddType "application/json; charset=UTF8" .json

RequestHeader set X_FORWARDED_PROTO 'https' env=https
RequestHeader set X_FORWARDED_PROTO 'http' env=!https
RequestHeader set x-apple-service-profile-manager-enabled true

RewriteEngine On

# Don't compress images
SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png)$ no-gzip dont-vary

# This is needed to workaround a mod_proxy bug <https://issues.apache.org/bugzilla/show_bug.cgi?id=37770>
# SetEnvIf Request_URI "/devicemanagement/.*" force-proxy-request-1.0=1
# SetEnvIf Request_URI "/devicemanagement/.*" proxy-nokeepalive=1

# This is needed to support case-insensitivity. It also corrects the case in the process with a redirect.
# This is only for http, and redirects all requests to the corresponding https URI
RewriteCond %{HTTPS} !on
  RewriteRule "^/mydevices/?$"      "https://%{HTTP_HOST}/mydevices/"       [NC,R=permanent]

RewriteCond %{HTTPS} !on
  RewriteRule "^/profilemanager/?$" "https://%{HTTP_HOST}/profilemanager/"  [NC,R=permanent]

# These redirects the browser to /profilemanager/ or /mydevices/ to keep the URL clean
RewriteRule "^/devicemanagement/webapi/device/start_ota/?$" "https://%{HTTP_HOST}/mydevices/"           [NC,R=permanent]
RewriteRule "^/devicemanagement/console/admin/?$"           "https://%{HTTP_HOST}/profilemanager/"      [NC,R=permanent]

# These catch some FileStore-based content that might be requested via regular HTTP
AliasMatch ^/devicemanagement/([^/]+\.(json|mobileconfig))$ /Library/Server/ProfileManager/Config/ServiceData/Data/FileStore/$1
AliasMatch ^/(MDMServiceConfig|DEPAnchorCerts)(\.json)?$    /Library/Server/ProfileManager/Config/ServiceData/Data/FileStore/$1.json

LoadModule status_module ${MODULE_INSTALL_PATH_PREFIX}/usr/libexec/apache2/mod_status.so
ProxyPass /devicemanagement/status !
<Location /devicemanagement/status>
  SetHandler server-status
  Require all denied
  Require ip 127.0.0.1
</Location>

# This is for SCEP, and doesn't run on SSL/TLS
<Location "/mdm/">
  <RequireAll>
    Require expr "%{HTTPS} != 'on'"
  </RequireAll>
  ProxyPass unix:/Library/Server/ProfileManager/Config/var/dmhttpd.sock|http://dmhttpd/mdm/
</Location>

