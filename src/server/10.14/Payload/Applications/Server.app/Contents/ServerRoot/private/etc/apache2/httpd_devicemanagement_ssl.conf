# These are equivalent (i.e., interchangable) URI prefixes:
#
# /devicemanagement/mdm/ <=> /devicemanagement/api/device/

SSLProxyEngine on
SSLCACertificateFile /Library/Server/ProfileManager/Config/SSLCACertificateFile.pem

SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1

Define DM_RootDir       "/Applications/Server.app/Contents/ServerRoot/usr/share/devicemgr"

Define DM_FrontendURI   "/devicemanagement/console"
Define DM_FrontendDir   "${DM_RootDir}/frontend"

Define DM_AdminURI      "/devicemanagement/admin"
Define DM_AdminDir      "${DM_FrontendDir}/admin"

Define DM_FileStoreDir  "/Library/Server/ProfileManager/Config/ServiceData/Data/FileStore"
Define DM_FileStoreURI  "/devicemanagement/files"

Define DM_StaticDir     "${DM_RootDir}/backend/public"
Define DM_StaticURI     "/devicemanagement/static"

# This is needed to support case-insensitivity. It also corrects the case in the process with a redirect.
RewriteCond %{REQUEST_URI} !^/mydevices/?$
  RewriteRule ^/mydevices/?$  "/mydevices/" [NC,R=permanent]

RewriteCond %{REQUEST_URI} !^/profilemanager/?$
  RewriteRule ^/profilemanager/?$  "/profilemanager/" [NC,R=permanent]


###################################################################################################################################
# Rewrite various inconsistent URLs into a simpler scheme that can use Alias/AliasMatch to then serve files from the file system. #
###################################################################################################################################

# Static Admin files
# These are equivalent (i.e., interchangable) URI prefixes:  /profilemanager/  <=> /devicemanagement/console/admin/

# This matches requests for admin files that have embedded UUIDs in the URI.
# The UUID is changed with each release of Server.app so cached files from older versions of Server aren't used instead.
RewriteRule "^/profilemanager/([^/]+)/[0-9a-fA-F]+/(.+)$"                         "${DM_AdminURI}/$1/app/$2" [PT,END]
RewriteRule "^/devicemanagement/console/admin/([^/]+)/[0-9a-fA-F]+/(.+)$"         "${DM_AdminURI}/$1/app/$2" [PT,END]

RewriteRule "^/profilemanager(/|/(.+))?$"                                         "${DM_AdminURI}/$2"    [PT,END]
RewriteRule "^/devicemanagement/console/(.+)$"                                    "${DM_FrontendURI}/$1" [PT,END]

# Config files
RewriteRule "^/(MDMServiceConfig|DEPAnchorCerts)(\.json)?$"                       "${DM_FileStoreURI}/$1.json" [PT,END]
RewriteRule "^/devicemanagement/([^/]+)\.(json|mobileconfig)$"                    "${DM_FileStoreURI}/$1.$2"   [PT,END]

# App and book icon files
RewriteRule "^/devicemanagement/(ipa|book)/([-0-9a-fA-F]+)\.(gif|jpeg|jpg|png)$"  "${DM_FileStoreURI}/$2.$3"        [PT,END]
RewriteRule "^/devicemanagement/(ipa|book)/generic_([^./]+).png$"                 "${DM_StaticURI}/generic_$2.png"  [PT,END]

# App & book files
RewriteRule "^/devicemanagement/ipa/([-0-9a-fA-F]+)\.(ipa|pkg)$"                  "${DM_FileStoreURI}/$1" [PT,END]
RewriteRule "^/devicemanagement/book/([-0-9a-fA-F]*)$"                            "${DM_FileStoreURI}/$1" [PT,END]

# Static URLs with embedded "version" UUIDs
RewriteRule "^/devicemanagement/static/[-0-9a-fA-F]+/(.+)$"                       "${DM_StaticURI}/$1" [PT,END]

#######################################################################################
# The Alias/AliasMatch directives that actually serve the files from the file system. #
#######################################################################################
# Static Admin files
Alias "${DM_AdminURI}"     "${DM_AdminDir}"
Alias "${DM_FrontendURI}"  "${DM_FrontendDir}"

# FileStore files
Alias "${DM_FileStoreURI}" "${DM_FileStoreDir}"

# Static files (always has a URI component after "/devicemanagement/static/")
Alias "${DM_StaticURI}"    "${DM_StaticDir}"


################################################################
# The following are all the URIs that are processed by dmhttpd #
################################################################
<Location "/auth">
  SSLRequireSSL
  RequestHeader set X-PM-REMOTE_ADDR          "%{REMOTE_ADDR}s"
  ProxyPass unix:/Library/Server/ProfileManager/Config/var/dmhttpd.sock|http://dmhttpd/auth
</Location>

<Location "/devicemanagement/mdm/mdm_connect">
  SSLRequireSSL
  SSLVerifyClient require
  SSLVerifyDepth 2
  SSLOptions +StdEnvVars +ExportCertData +StrictRequire +OptRenegotiate +LegacyCertChainVerify
  SSLRenegBufferSize 2097152
  RequestHeader set X-PM-REMOTE_ADDR          "%{REMOTE_ADDR}s"
  RequestHeader set X-PM-SSL_CLIENT_V_REMAIN  "%{SSL_CLIENT_V_REMAIN}s"
  RequestHeader set X-PM-SSL_CLIENT_S_DN_CN   "%{SSL_CLIENT_S_DN_CN}s"
  RequestHeader set X-PM-SSL_CLIENT_VERIFY    "%{SSL_CLIENT_VERIFY}s"
  ProxyPass unix:/Library/Server/ProfileManager/Config/var/dmhttpd.sock|http://dmhttpd/devicemanagement/secure/mdm_connect
</Location>

<Location "/devicemanagement/mdm/mdm_checkin">
  SSLRequireSSL
  SSLVerifyClient require
  SSLVerifyDepth 2
  SSLOptions +StdEnvVars +ExportCertData +StrictRequire +OptRenegotiate +LegacyCertChainVerify
  SSLRenegBufferSize 2097152
  RequestHeader set X-PM-REMOTE_ADDR          "%{REMOTE_ADDR}s"
  RequestHeader set X-PM-SSL_CLIENT_V_REMAIN  "%{SSL_CLIENT_V_REMAIN}s"
  RequestHeader set X-PM-SSL_CLIENT_S_DN_CN   "%{SSL_CLIENT_S_DN_CN}s"
  RequestHeader set X-PM-SSL_CLIENT_VERIFY    "%{SSL_CLIENT_VERIFY}s"
  ProxyPass unix:/Library/Server/ProfileManager/Config/var/dmhttpd.sock|http://dmhttpd/devicemanagement/secure/mdm_checkin
</Location>

<Location "/devicemanagement/mdm/mdm_vend_image">
  SSLRequireSSL
  SSLVerifyClient require
  SSLVerifyDepth 2
  SSLOptions +StdEnvVars +ExportCertData +StrictRequire +OptRenegotiate +LegacyCertChainVerify
  SSLRenegBufferSize 2097152
  RequestHeader set X-PM-REMOTE_ADDR          "%{REMOTE_ADDR}s"
  RequestHeader set X-PM-SSL_CLIENT_V_REMAIN  "%{SSL_CLIENT_V_REMAIN}s"
  RequestHeader set X-PM-SSL_CLIENT_S_DN_CN   "%{SSL_CLIENT_S_DN_CN}s"
  RequestHeader set X-PM-SSL_CLIENT_VERIFY    "%{SSL_CLIENT_VERIFY}s"
  ProxyPass unix:/Library/Server/ProfileManager/Config/var/dmhttpd.sock|http://dmhttpd/devicemanagement/secure/mdm_vend_image
</Location>

<Location "/devicemanagement/mdm/auto_join_ota_service">
  SSLRequireSSL
  RequestHeader set X-PM-REMOTE_ADDR          "%{REMOTE_ADDR}s"
  ProxyPass unix:/Library/Server/ProfileManager/Config/var/dmhttpd.sock|http://dmhttpd/devicemanagement/enroll/auto_join_ota_service
</Location>

<Location "/devicemanagement/mdm/dep_mdm_enroll">
  SSLRequireSSL
  RequestHeader set X-PM-REMOTE_ADDR          "%{REMOTE_ADDR}s"
  ProxyPass unix:/Library/Server/ProfileManager/Config/var/dmhttpd.sock|http://dmhttpd/devicemanagement/enroll/dep_mdm_enroll
</Location>

<Location "/devicemanagement/mdm/mdm_enroll">
  SSLRequireSSL
  RequestHeader set X-PM-REMOTE_ADDR          "%{REMOTE_ADDR}s"
  ProxyPass unix:/Library/Server/ProfileManager/Config/var/dmhttpd.sock|http://dmhttpd/devicemanagement/enroll/mdm_enroll
</Location>

<Location "/devicemanagement/mdm/mdm_vend_manifest">
  SSLRequireSSL
  RequestHeader set X-PM-REMOTE_ADDR          "%{REMOTE_ADDR}s"
  ProxyPass unix:/Library/Server/ProfileManager/Config/var/dmhttpd.sock|http://dmhttpd/devicemanagement/mdm/mdm_vend_manifest
</Location>


<Location "/devicemanagement/mdm/checkin">
  SSLRequireSSL
  RequestHeader set X-PM-REMOTE_ADDR          "%{REMOTE_ADDR}s"
  ProxyPass unix:/Library/Server/ProfileManager/Config/var/dmhttpd.sock|http://dmhttpd/devicemanagement/legacy/checkin
</Location>

<Location "/devicemanagement/mdm/connect">
  SSLRequireSSL
  RequestHeader set X-PM-REMOTE_ADDR          "%{REMOTE_ADDR}s"
  ProxyPass unix:/Library/Server/ProfileManager/Config/var/dmhttpd.sock|http://dmhttpd/devicemanagement/legacy/connect
</Location>


<Location "/devicemanagement/vpp/">
  SSLRequireSSL
  RequestHeader set X-PM-REMOTE_ADDR          "%{REMOTE_ADDR}s"
  ProxyPass unix:/Library/Server/ProfileManager/Config/var/dmhttpd.sock|http://dmhttpd/devicemanagement/vpp/
</Location>

<Location "/devicemanagement/mdm/accept_invitation">
  SSLRequireSSL
  RequestHeader set X-PM-REMOTE_ADDR          "%{REMOTE_ADDR}s"
  ProxyPass unix:/Library/Server/ProfileManager/Config/var/dmhttpd.sock|http://dmhttpd/devicemanagement/vpp/accept_invitation_old
</Location>

#######################################
# Do them all again for /api/device/ #
#######################################
<Location "/devicemanagement/api/device/mdm_connect">
  SSLRequireSSL
  SSLVerifyClient require
  SSLVerifyDepth 2
  SSLOptions +StdEnvVars +ExportCertData +StrictRequire +OptRenegotiate +LegacyCertChainVerify
  SSLRenegBufferSize 2097152
  RequestHeader set X-PM-REMOTE_ADDR          "%{REMOTE_ADDR}s"
  RequestHeader set X-PM-SSL_CLIENT_V_REMAIN  "%{SSL_CLIENT_V_REMAIN}s"
  RequestHeader set X-PM-SSL_CLIENT_S_DN_CN   "%{SSL_CLIENT_S_DN_CN}s"
  RequestHeader set X-PM-SSL_CLIENT_VERIFY    "%{SSL_CLIENT_VERIFY}s"
  ProxyPass unix:/Library/Server/ProfileManager/Config/var/dmhttpd.sock|http://dmhttpd/devicemanagement/secure/mdm_connect
</Location>

<Location "/devicemanagement/api/device/mdm_checkin">
  SSLRequireSSL
  SSLVerifyClient require
  SSLVerifyDepth 2
  SSLOptions +StdEnvVars +ExportCertData +StrictRequire +OptRenegotiate +LegacyCertChainVerify
  SSLRenegBufferSize 2097152
  RequestHeader set X-PM-REMOTE_ADDR          "%{REMOTE_ADDR}s"
  RequestHeader set X-PM-SSL_CLIENT_V_REMAIN  "%{SSL_CLIENT_V_REMAIN}s"
  RequestHeader set X-PM-SSL_CLIENT_S_DN_CN   "%{SSL_CLIENT_S_DN_CN}s"
  RequestHeader set X-PM-SSL_CLIENT_VERIFY    "%{SSL_CLIENT_VERIFY}s"
  ProxyPass unix:/Library/Server/ProfileManager/Config/var/dmhttpd.sock|http://dmhttpd/devicemanagement/secure/mdm_checkin
</Location>

<Location "/devicemanagement/api/device/auto_join_ota_service">
  SSLRequireSSL
  RequestHeader set X-PM-REMOTE_ADDR          "%{REMOTE_ADDR}s"
  ProxyPass unix:/Library/Server/ProfileManager/Config/var/dmhttpd.sock|http://dmhttpd/devicemanagement/enroll/auto_join_ota_service
</Location>

<Location "/devicemanagement/api/device/dep_mdm_enroll">
  SSLRequireSSL
  RequestHeader set X-PM-REMOTE_ADDR          "%{REMOTE_ADDR}s"
  ProxyPass unix:/Library/Server/ProfileManager/Config/var/dmhttpd.sock|http://dmhttpd/devicemanagement/enroll/dep_mdm_enroll
</Location>

<Location "/devicemanagement/api/device/checkin">
  SSLRequireSSL
  RequestHeader set X-PM-REMOTE_ADDR          "%{REMOTE_ADDR}s"
  ProxyPass unix:/Library/Server/ProfileManager/Config/var/dmhttpd.sock|http://dmhttpd/devicemanagement/legacy/checkin
</Location>

<Location "/devicemanagement/api/device/connect">
  SSLRequireSSL
  RequestHeader set X-PM-REMOTE_ADDR          "%{REMOTE_ADDR}s"
  ProxyPass unix:/Library/Server/ProfileManager/Config/var/dmhttpd.sock|http://dmhttpd/devicemanagement/legacy/connect
</Location>

<Location "/devicemanagement/api/device/accept_invitation">
  SSLRequireSSL
  RequestHeader set X-PM-REMOTE_ADDR          "%{REMOTE_ADDR}s"
  ProxyPass unix:/Library/Server/ProfileManager/Config/var/dmhttpd.sock|http://dmhttpd/devicemanagement/vpp/accept_invitation_old
</Location>

# Apache times out after 1 minute for all the requests it reverse proxies.
# But we want the timeout to be atleast 5 minutes for Admin get_updated requests.
# There is no way to configure timeouts that is specific to a ProxyPass. So we have to make
# Apache wait for 5 minutes for all the requests its proxies through.
ProxyTimeout 300

# This proxies the requests destined for the Rails processes
<Proxy "balancer://com.apple.devicemgr.rails">
  BalancerMember http://127.0.0.1:3320
  BalancerMember http://127.0.0.1:3321
  BalancerMember http://127.0.0.1:3322
  BalancerMember http://127.0.0.1:3323
  BalancerMember http://127.0.0.1:3324
  BalancerMember http://127.0.0.1:3325
  BalancerMember http://127.0.0.1:3326
  BalancerMember http://127.0.0.1:3327
  BalancerMember http://127.0.0.1:3328
  BalancerMember http://127.0.0.1:3329
</Proxy>

<LocationMatch "^/mydevices/?$">
  Header set X-Frame-Options "SameOrigin"
  ProxyPassMatch   balancer://com.apple.devicemgr.rails/device/start_ota
  ProxyPassReverse balancer://com.apple.devicemgr.rails/device/start_ota
</LocationMatch>

<LocationMatch "^/devicemanagement/webapi/(.+)$">
  ProxyPassMatch   balancer://com.apple.devicemgr.rails/$1
  ProxyPassReverse balancer://com.apple.devicemgr.rails/$1
</LocationMatch>


#############################################################################
# Grant access to the directories that hold all the files we serve directly #
#############################################################################
<Directory "${DM_StaticDir}">
  Require all granted
  Header set X-Frame-Options "SameOrigin"
  <IfModule mod_expires.c>
    ExpiresActive On
    ExpiresDefault "access plus 1 year"
    ExpiresByType text/html "access"
  </IfModule>

  <IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE image/svg+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/atom_xml
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/x-httpd-php
    AddOutputFilterByType DEFLATE application/x-httpd-fastphp
    AddOutputFilterByType DEFLATE application/x-httpd-eruby
    AddOutputFilterByType DEFLATE text/html
  </IfModule>
</Directory>

<Directory "${DM_FileStoreDir}">
  Require all granted
</Directory>

<Directory "${DM_FrontendDir}">   # Includes DM_AdminDir
  Options FollowSymLinks MultiViews

  Require all granted
  Header set X-Frame-Options "SameOrigin"
  <IfModule mod_expires.c>
    ExpiresActive On
    ExpiresDefault "access plus 1 year"
    ExpiresByType text/html "access"
  </IfModule>

  <IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE image/svg+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/atom_xml
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/x-httpd-php
    AddOutputFilterByType DEFLATE application/x-httpd-fastphp
    AddOutputFilterByType DEFLATE application/x-httpd-eruby
    AddOutputFilterByType DEFLATE text/html
  </IfModule>

  AddLanguage en    .en
  AddLanguage nl    .nl
  AddLanguage fr    .fr
  AddLanguage de    .de
  AddLanguage it    .it
  AddLanguage ja    .ja
  AddLanguage es    .es
  AddLanguage ko    .ko
  AddLanguage ru    .ru
  AddLanguage zh-cn .zh_CN
  AddLanguage zh-tw .zh_TW

  # Insert filter
  # SetOutputFilter DEFLATE

  # Netscape 4.x has some problems...
  BrowserMatch ^Mozilla/4 gzip-only-text/html
  # Netscape 4.06-4.08 have some more problems
  BrowserMatch ^Mozilla/4\.0[678] no-gzip
  # MSIE masquerades as Netscape, but it is fine
  # BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
  # NOTE: Due to a bug in mod_setenvif up to Apache 2.0.48
  # the above regex won't work. You can use the following
  # workaround to get the desired effect:
  BrowserMatch \bMSI[E] !no-gzip !gzip-only-text/html
</Directory>
